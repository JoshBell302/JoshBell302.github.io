<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../Styles/styles.css">
    <title>Chance Time</title>
</head>

<body>
    <!-- Create the site header -->
    <div id="site-header"></div>
    <script src="/header/loadHeader.js"></script>

    <div>
        <canvas id="leftCanvas" width="500" height="500" style="border: 3px solid;"></canvas>
        <canvas id="middleCanvas" width="500" height="500" style="border: 3px solid;"></canvas>
        <canvas id="rightCanvas" width="500" height="500" style="border: 3px solid;"></canvas>
        <button id="spinButton">SPIN</button>
    </div>

    <script src="../spinningwheel/wheel.js"></script>
    <script src="../spinningwheel/icon.js"></script>
    <script src="../spinningwheel/result.js"></script>
    <script>
        // Create the contexts for the wheels
        const contexts = [leftCanvas.getContext("2d"), middleCanvas.getContext("2d"), rightCanvas.getContext("2d")];
        const leftCenters = {x: leftCanvas.width / 2, y: leftCanvas.height / 2}
        const middleCenters = {x: middleCanvas.width / 2, y: middleCanvas.height / 2}
        const rightCenters = {x: rightCanvas.width / 2, y: rightCanvas.height / 2}
        const radii = [leftCanvas.width * 0.4, middleCanvas.width * 0.4, rightCanvas.width * 0.4];
        const wheelBorderSize = 5;

        // Create all Icons for use on the Wheel
        const marioIcon = new Icon("Mario", "../Characters/mario_icon.png", "#e52521");
        const luigiIcon = new Icon("Luigi", "../Characters/luigi_icon.png", "#4cbb17");
        const peachIcon = new Icon("Peach", "../Characters/peach_icon.png", "#f192bd");
        const booIcon = new Icon("Boo", "../Characters/boo_icon.png", "#eaf9fe");
        const paulineIcon = new Icon("Pauline", "../Characters/pauline_icon.png", "#810000");
        const yoshiIcon = new Icon("Yoshi", "../Characters/yoshi_icon.png", "#68d154");
        const plantIcon = new Icon("Piranha Plant", "../Characters/plant_icon.png", "#158371");
        const royIcon = new Icon("Roy", "../Characters/roy_icon.png", "#61317d");
        const waluigiIcon = new Icon("Waluigi", "../Characters/waluigi_icon.png", "#7e0cd6");
        const bowserIcon = new Icon("Bowser", "../Characters/bowser_icon.png", "#10a30c");
        const rosalinaIcon = new Icon("Rosalina", "../Characters/rosalina_icon.png", "#00e6e6");
        const lumaIcon = new Icon("Luma", "../Characters/luma_icon.png", "#ffd700");
        const shyguyIcon = new Icon("Shy Guy", "../Characters/shyguy_icon.png", "#aa0055");


        // Icons to be used on the specific Wheels
        const mainIcons = [marioIcon, luigiIcon, peachIcon, bowserIcon];
        const centerIcons = [paulineIcon, rosalinaIcon, lumaIcon, yoshiIcon]

        // Create the Wheel classes
        const leftwheel = new Wheel(leftCenters, radii[0], mainIcons);
        const middlewheel = new Wheel(middleCenters, radii[1], centerIcons);
        const rightwheel = new Wheel(rightCenters, radii[2], mainIcons);

        // Create background wheels
        for (let i = 0; i < contexts.length; i++) {
            contexts[i].beginPath();
            contexts[i].arc(leftCenters.x, leftCenters.y, radii[i] + wheelBorderSize, 0, 2 * Math.PI);
            contexts[i].fillStyle = "white";
            contexts[i].fill();
        }

        // Set variable memory for the animations and wheels
        const iconSize = 75;
        const arrowWidth = 25;
        const arrowLength = 45;

        let animationId = null;
        let angleSpeed = 1000;
        let leftRandomAngle = 0;
        let middleRandomAngle = 0;
        let rightRandomAngle = 0;

        // Create SPIN button handler
        document.getElementById("spinButton").addEventListener("click", () => {
            // Calculate the random angle adjustments and begin animations
            leftRandomAngle = Math.floor(Math.random() * 10000);
            middleRandomAngle = Math.floor(Math.random() * 10000);
            rightRandomAngle = Math.floor(Math.random() * 10000);
            animationId = requestAnimationFrame(animate);
	    });

        function animate() {
            // Calculate rotation speed
            let leftAngle = (0.1 * angleSpeed) + (leftRandomAngle);
            let middleAngle = (0.1 * angleSpeed) + (middleRandomAngle);
            let rightAngle = (0.1 * angleSpeed) + (rightRandomAngle);
            if (angleSpeed > 1){
                angleSpeed*=0.99;
            }
            else {
                // Grab data of what pixel the arrows are pointing to and alert user of the landed slices
                const leftPixelResultData = contexts[0].getImageData(leftCanvas.width/2, (leftCanvas.height/2-(radii[0]))+(arrowLength/3)+1, 1, 1).data;
                const middlePixelResultData = contexts[1].getImageData(middleCanvas.width/2, (middleCanvas.height/2-(radii[0]))+(arrowLength/3)+1, 1, 1).data;
                const rightPixelResultData = contexts[2].getImageData(rightCanvas.width/2, (rightCanvas.height/2-(radii[0]))+(arrowLength/3)+1, 1, 1).data;
                sliceResult(leftPixelResultData, mainIcons)
                sliceResult(middlePixelResultData, centerIcons)
                sliceResult(rightPixelResultData, mainIcons)
                cancelAnimationFrame(animationId);
                return;
            }
            
            // Draw the wheel with an angle adjustment to simulate it spinning
            leftwheel.draw(contexts[0], leftAngle, iconSize, arrowWidth, arrowLength);
            middlewheel.draw(contexts[1], middleAngle, iconSize, arrowWidth, arrowLength);
            rightwheel.draw(contexts[2], rightAngle, iconSize, arrowWidth, arrowLength);
            animationId = requestAnimationFrame(animate);
        }
    </script>
</body>

</html>